/*! 2016-08-15 17:40:11 */
angular.module("locator",["ngSanitize","xom.shared"]).config(["$locationProvider",function(a){a.html5Mode(!0)}]),angular.module("locator").controller("LocatorCtrl",["$scope","$location","$log","locationSvc","amenitiesSvc","eventBusSvc","geolocationSvc","arraySvc","facetSvc","extenderSvc","MAP","LOCATOR",function(a,b,c,d,e,f,g,h,i,j,k,l){function m(){G(),e.get().then(p),P=n(),P&&(a.mapSettings.center=N(a.filters)||a.filters.q),l.disableGeolocation||o()}function n(){var c=b.search(),d=j.extend({},a.filters,c),e=!1;for(var f in a.filters)d[f]&&(e=!0);return angular.extend(a.filters,d),e}function o(){g.getCurrentPosition().then(q,r)}function p(b){a.amenities=b}function q(b){a.userLocation=b.coords,a.searchResults.length||P||(a.mapSettings.center=b.coords)}function r(){a.searchResults.length||(a.mapSettings.center=k.center)}function s(b){l.disableBoundarySearch||(angular.extend(a.filters,b),y())}function t(b,c){angular.extend(a.filters,c),a.mapSettings.center=c.q,a.$apply()}function u(b){b.selected=!b.selected,a.filters.selectedFacets=i.serializeFacets(a.facets),y()}function v(a){a.selected||f.publish("xom.analytics",{cg:"Station filter",csg:a.Name,ct:"Checkbox"})}function w(a){f.publish("xom.analytics",{cg:"Map",csg:a,ct:a,et:a})}function x(a){f.publish("xom.analytics",{cg:"Map",csg:a.data.DisplayName,ct:"Click",en:"Click",et:"Click"})}function y(){F(!0);var b=angular.copy(a.filters);b.center=N(a.filters),d.searchByBoundary(b).then(z).catch(C).finally(F)}function z(b){a.facets=b.facets,i.applyFacetSelections(a.facets,a.filters.selectedFacets),a.searchResults=angular.isArray(b)?b:b[l.apiResultsKey],b[l.apiPhraseKey]&&(a.filters.q=b[l.apiPhraseKey]),H(),D()}function A(b){a.mapPins=h.map(a.filteredResults,function(a,c){return{id:a.LocationID,data:a,popup:b[c],position:{latitude:a.Latitude,longitude:a.Longitude},image:B(a)}})}function B(a){if(l.pinStyleMap)for(var b in l.pinStyleMap.values)if(a[l.pinStyleMap.field]===b)return l.pinStyleMap.values[b];return k.pin?k.pin.image:void c.warn("Unable to map pin image.")}function C(b){a.error=b}function D(){var c=angular.extend({},a.filters);E(c),b.search(c).replace()}function E(a){for(var b in a)a[b]||delete a[b]}function F(a){f.publish("xom.loading",!!a)}function G(){l.phraseEventName&&f.subscribe(l.phraseEventName,t)}function H(){var b=I();0===b.length?a.filteredResults=a.searchResults:a.filteredResults=a.searchResults.filter(function(a){return L(a,b)})}function I(){return a.amenities.filter?a.amenities.filter(J).map(K):[]}function J(a){return!!a.selected}function K(a){return a.Name}function L(a,b){for(var c=0;c<b.length;c++)if(M(a,b[c]))return!0}function M(a,b){return a.StoreAmenities.filter(function(a){return a.Name===b}).length>0}function N(a){try{var b=parseFloat(a.latitude1),c=parseFloat(a.latitude2),d=parseFloat(a.longitude1),e=parseFloat(a.longitude2),f={latitude:c-(c-b)/2,longitude:e-(e-d)/2};return isNaN(f.latitude)||isNaN(f.longitude)?null:f}catch(a){return null}}var O=angular.copy(k),P=!1;O.center=null,a.amenities=[],a.facets=[],a.filters={latitude1:null,longitude1:null,latitude2:null,longitude2:null,q:"",selectedFacets:""},a.filteredResults=[],a.locatorConfig=l,a.mapSettings=O,a.mapPins=[],a.onBeforeFilterClick=v,a.onMapInteraction=w,a.onPinOpened=x,a.onPinPopupHtmlReady=A,a.searchResults=[],a.userLocation=null,a.onBoundaryChanged=s,a.toggleFacetValue=u,a.$watch("amenities",H,!0),m()}]),angular.module("locator").service("amenitiesSvc",["$http","$q","LOCATOR",function(a,b,c){"use strict";function d(){var d=b.defer();return c.amenities?d.resolve(c.amenities):c.amenitiesUrl?a({method:"GET",url:c.amenitiesUrl}).then(function(a){d.resolve(a.data)}).catch(function(){d.reject("Failed to load amenities.")}):d.resolve([]),d.promise}return{get:d}}]),angular.module("locator").service("locationSvc",["$http","$q","$interpolate","$log","LOCATOR",function(a,b,c,d,e){"use strict";function f(a){return e.boundaryApi?h(e.boundaryApi,a):void d.warn("No boundary search endpoint configured.")}function g(a){return e.phraseApi?h(e.phraseApi,a):void d.warn("No phrase search endpoint configured.")}function h(d,e){var f=b.defer(),g=c(d),h=g(e);return a({method:"GET",url:h}).then(function(a){f.resolve(a.data)}).catch(function(){f.reject("Failed to load locations.")}),f.promise}return{searchByBoundary:f,searchByPhrase:g}}]),function(a){a("script[data-app]").each(function(){var b=a(this),c=b.data("app"),d=a.parseJSON(b.html());for(var e in d)angular.module(c).constant(e,d[e])})}(window.jQuery),angular.module("xom.shared",[]),function(a){"use strict";angular.module("xom.shared").directive("map",["$timeout",function(a){function b(b,c){c.mapify(b.settings);var d=function(a,d){angular.isFunction(b[a])&&c.mapify(a,function(c){var e={};e[d]=c,b[a](e)})};d("onBoundaryChanged","boundary"),d("onCenterSet","center"),d("onGeocode","result"),d("onInteraction","type"),d("onPinOpened","pin"),b.$watch("settings.center",function(a){a&&c.mapify("center",a)}),b.$watch("pins",function(d){var e=d||[];c.mapify("setPins",e),e.length&&b.autoBoundary&&a(function(){(b.onBoundaryAdjust||angular.noop)({adjusting:!0}),c.mapify("setBoundaryToPins")},100)})}return{restrict:"E",replace:!0,scope:{autoBoundary:"=",onBoundaryChanged:"&",onCenterSet:"&",onGeocode:"&",onInteraction:"&",onPinOpened:"&",pins:"=",settings:"="},template:'<div class="map"></div>',link:function(a,c){var d=a.$watch("settings.center",function(e){e&&(d(),b(a,c))})}}}])}(window.jQuery),angular.module("xom.shared").directive("stringTemplate",["$timeout",function(a){"use strict";return{link:function(b,c){b.$watch("trigger",function(d){a(function(){var a=[];angular.isDefined(d)&&c.children().each(function(b,c){a.push(angular.element(c).html())}),b.callback({templates:a})},50)})},restrict:"E",scope:{trigger:"=",callback:"&"}}}]),function(a){angular.module("xom.shared").factory("arraySvc",function(){"use strict";function b(b,c){return a.map(b,c)}return{map:b}})}(window.jQuery),function(a){"use strict";angular.module("xom.shared").factory("eventBusSvc",function(){return{publish:a.publish,subscribe:a.subscribe}})}(window.jQuery),angular.module("xom.shared").service("extenderSvc",function(){"use strict";function a(){if(0===arguments.length||"object"!=typeof arguments[0])return{};for(var a=arguments[0],c=1;c<arguments.length;c++)"object"==typeof arguments[c]&&b(arguments[c],a);return a}function b(a,b){for(var d in a)if(a.hasOwnProperty(d)&&null!==a[d]){var e=c(b,d);b[e]=angular.copy(a[d])}}function c(a,b){var c=b.toLowerCase();for(var d in a)if(d.toLowerCase()===c)return d;return b}return{copyProperties:b,extend:a,getPropertyName:c}}),angular.module("xom.shared").factory("facetSvc",["serializationSvc",function(a){"use strict";function b(a,b,c){var d=h(a,b);if(null!==d){var e=h(d.values,c);return e&&e.selected===!0}}function c(a,b,c){var d=h(a,b);if(null!==d){var e=h(d.values,c);null!==e&&(e.selected=!e.selected)}}function d(a,b){for(var c=0;c<a.length;c++){var d=h(b,a[c].key);if(null!==d)for(var e=0;e<a[c].values.length;e++){var f=h(d.values,a[c].values[e].key);null!==f&&(a[c].values[e].selected=f.selected)}}return a}function e(a){for(var b=[],c=0;c<a.length;c++){var d=a[c],e=(d.values||[]).filter(g);0!==e.length&&b.push(d.key+":"+e.map(j).join(","))}return b.join("|")}function f(a,b){if(b)for(var c=k(b),d=0;d<a.length;d++){var e=a[d],f=i(c,e.key);if(null!==f&&0!==f.length)for(var g=0;g<e.values.length;g++){var h=e.values[g];h.selected=l(f,h.key)}}}function g(a){return a.selected===!0}function h(a,b){var c=b.toLowerCase(),d=a.filter(function(a){return a.key.toLowerCase()===c});return d.length>0?d[0]:null}function i(a,b){var c=b.toLowerCase();for(var d in a)if(d.toLowerCase()===c)return a[d];return null}function j(a){return a.key}function k(b){var c=a.deserialize(b,"|",":");for(var d in c)null!==c[d]&&(c[d]=c[d].split(","));return c}function l(a,b){var c=b.toLowerCase();return a.filter(function(a){return a.toLowerCase()===c}).length>0}return{applyFacetSelections:f,isFacetValueSelected:b,mergeFacets:d,serializeFacets:e,toggleFacetValue:c}}]),angular.module("xom.shared").factory("geolocationSvc",["$q","$window",function(a,b){"use strict";function c(){var c=a.defer();return b.navigator.geolocation?b.navigator.geolocation.getCurrentPosition(c.resolve,c.reject):c.reject("Geolocation not supported."),c.promise}return{getCurrentPosition:c}}]),angular.module("xom.shared").service("serializationSvc",function(){"use strict";function a(a,b,c){var d=[];for(var e in a)a.hasOwnProperty(e)&&null!==a[e]&&""!==a[e]&&d.push(e+c+a[e]);return d.join(b)}function b(a,b,c){var d={},e=new RegExp("([^?"+c+b+"]+)("+c+"([^"+b+"]*))?","g");return a.replace(e,function(a,b,c,e){d[b]=e}),d}return{serialize:a,deserialize:b,toQueryString:function(b){return a(b,"&","=")},fromQueryString:function(a){return b(a,"&","=")}}});