/*! 2017-08-18 11:27:16 */

angular.module("gdl",["ngSanitize","xom.shared"]).config(["$locationProvider",function(a){a.html5Mode(!0)}]),angular.module("gdl").controller("GdlCtrl",["$scope","$timeout","$location","locationSvc","eventBusSvc","arraySvc","facetSvc","extenderSvc","MAP","GDL",function(a,b,c,d,e,f,g,h,i,j){function k(){j.searchEventName&&(e.subscribe(j.searchEventName,n),e.subscribe("xom.geolocation",o))}function l(){var b=c.search();return!!b.q&&(a.mapSettings.center=a.filters.q=b.q,!0)}function m(){a.autoBoundary=!0,a.centerPin=null,a.countryIsSelected=!1,a.facets=[],a.filters.countryRegion=null,a.filters.latitude=null,a.filters.longitude=null,a.searchFailed=!1,a.searchResults=[]}function n(b,c){a.mapSettings.center=c.q,a.$apply()}function o(b,c){if(!a.filters.q){var d={latitude:c.lat,longitude:c.lng};a.filters.q=c.name,a.mapSettings.center=d,y(d),r(),a.$apply()}}function p(b){if(b.name!==i.center){var c=!0;if(m(),0===b.count&&(a.searchFailed=!0,c=!1),b.type.toLowerCase().indexOf("country")>-1&&(a.autoBoundary=!1,a.countryIsSelected=!0,c=!1),a.filters.q=b.name,y(b),!c)return t(),void a.$apply();angular.extend(a.filters,b),r()}}function q(b){b.selected=!b.selected,a.filters.selectedFacets=g.serializeFacets(a.facets),r()}function r(){A(!0),d.search(a.filters).then(s).catch(z).finally(A)}function s(b){a.facets=b.facets,g.applyFacetSelections(a.facets,a.filters.selectedFacets),a.searchFailed=0===b.results.length,a.searchResults=b.results,t()}function t(){a.templateTrigger++}function u(b){var c=f.map(a.searchResults,function(a,c){return{id:a[j.distributorIdField||"Id"],data:a,popup:b[c],position:{latitude:a.Latitude,longitude:a.Longitude}}});a.centerPin&&c.push(a.centerPin),a.mapPins=c}function v(a,b){q(b),b.selected&&e.publish("xom.analytics",{cg:"Filter",csg:a.Name,ct:"Checkbox"})}function w(a){e.publish("xom.analytics",{cg:"Map",csg:a,ct:a,et:a})}function x(a){e.publish("xom.analytics",{cg:"Map",csg:a.data.DisplayName,ct:"Click",en:"Click",et:"Click"})}function y(b){a.centerPin=b&&b.latitude?{id:"center-pin-"+b.latitude+"-"+b.longitude,style:j.centerPin,position:b}:null}function z(){a.searchFailed=!0,t()}function A(a){e.publish("xom.loading",!!a)}a.autoBoundary=!0,a.centerPin=null,a.countryIsSelected=!1,a.facets=j.facets,a.filters={latitude:null,longitude:null,countryRegion:null,selectedFacets:""},a.mapPins=[],a.mapSettings=angular.copy(i),a.onFilterValueClick=v,a.onGeocode=p,a.onMapInteraction=w,a.onPinOpened=x,a.onPinPopupHtmlReady=u,a.searchFailed=!1,a.searchResults=[],a.templateTrigger=1,a.toggleFacetValue=q,a.userLocation=null,function(){k(),l()}()}]),angular.module("gdl").service("locationSvc",["$http","$q","$interpolate","$log","GDL",function(a,b,c,d,e){"use strict";function f(f){if(!e.searchApi)return void d.warn("No boundary search endpoint configured.");var g=b.defer(),h=c(e.searchApi),i=h(f);return a({method:"GET",url:i}).then(function(a){g.resolve(a.data)}).catch(function(){g.reject("Failed to load locations.")}),g.promise}return{search:f}}]),function(a){a("script[data-app]").each(function(){var b=a(this),c=b.data("app"),d=a.parseJSON(b.html());for(var e in d)angular.module(c).constant(e,d[e])})}(window.jQuery),angular.module("xom.shared",[]),function(a){"use strict";angular.module("xom.shared").directive("map",["$timeout",function(a){function b(b,c){c.mapify(b.settings);var d=function(a,d){angular.isFunction(b[a])&&c.mapify(a,function(c){var e={};e[d]=c,b[a](e)})};d("onBoundaryChanged","boundary"),d("onCenterSet","center"),d("onGeocode","result"),d("onInteraction","type"),d("onPinOpened","pin"),b.$watch("settings.center",function(a){a&&c.mapify("center",a)}),b.$watch("pins",function(d){var e=d||[];c.mapify("setPins",e),e.length&&b.autoBoundary&&a(function(){(b.onBoundaryAdjust||angular.noop)({adjusting:!0}),c.mapify("setBoundaryToPins")},100)})}return{restrict:"E",replace:!0,scope:{autoBoundary:"=",onBoundaryChanged:"&",onCenterSet:"&",onGeocode:"&",onInteraction:"&",onPinOpened:"&",pins:"=",settings:"="},template:'<div class="map"></div>',link:function(a,c){var d=a.$watch("settings.center",function(e){e&&(d(),b(a,c))})}}}])}(window.jQuery),angular.module("xom.shared").directive("stringTemplate",["$timeout",function(a){"use strict";return{link:function(b,c){b.$watch("trigger",function(d){a(function(){var a=[];angular.isDefined(d)&&c.children().each(function(b,c){a.push(angular.element(c).html())}),b.callback({templates:a})},50)})},restrict:"E",scope:{trigger:"=",callback:"&"}}}]),function(a){angular.module("xom.shared").factory("arraySvc",function(){"use strict";function b(b,c){return a.map(b,c)}return{map:b}})}(window.jQuery),function(a){"use strict";angular.module("xom.shared").factory("eventBusSvc",function(){return{publish:a.publish,subscribe:a.subscribe}})}(window.jQuery),angular.module("xom.shared").service("extenderSvc",function(){"use strict";function a(){if(0===arguments.length||"object"!=typeof arguments[0])return{};for(var a=arguments[0],c=1;c<arguments.length;c++)"object"==typeof arguments[c]&&b(arguments[c],a);return a}function b(a,b){for(var d in a)if(a.hasOwnProperty(d)&&null!==a[d]){var e=c(b,d);b[e]=angular.copy(a[d])}}function c(a,b){var c=b.toLowerCase();for(var d in a)if(d.toLowerCase()===c)return d;return b}return{copyProperties:b,extend:a,getPropertyName:c}}),angular.module("xom.shared").factory("facetSvc",["serializationSvc",function(a){"use strict";function b(a,b,c){var d=h(a,b);if(null!==d){var e=h(d.values,c);return e&&!0===e.selected}}function c(a,b,c){var d=h(a,b);if(null!==d){var e=h(d.values,c);null!==e&&(e.selected=!e.selected)}}function d(a,b){for(var c=0;c<a.length;c++){var d=h(b,a[c].key);if(null!==d)for(var e=0;e<a[c].values.length;e++){var f=h(d.values,a[c].values[e].key);null!==f&&(a[c].values[e].selected=f.selected)}}return a}function e(a){for(var b=[],c=0;c<a.length;c++){var d=a[c],e=(d.values||[]).filter(g);0!==e.length&&b.push(d.key+":"+e.map(j).join(","))}return b.join("|")}function f(a,b){if(b)for(var c=k(b),d=0;d<a.length;d++){var e=a[d],f=i(c,e.key);if(null!==f&&0!==f.length)for(var g=0;g<e.values.length;g++){var h=e.values[g];h.selected=l(f,h.key)}}}function g(a){return!0===a.selected}function h(a,b){var c=b.toLowerCase(),d=a.filter(function(a){return a.key.toLowerCase()===c});return d.length>0?d[0]:null}function i(a,b){var c=b.toLowerCase();for(var d in a)if(d.toLowerCase()===c)return a[d];return null}function j(a){return a.key}function k(b){var c=a.deserialize(b,"|",":");for(var d in c)null!==c[d]&&(c[d]=c[d].split(","));return c}function l(a,b){var c=b.toLowerCase();return a.filter(function(a){return a.toLowerCase()===c}).length>0}return{applyFacetSelections:f,isFacetValueSelected:b,mergeFacets:d,serializeFacets:e,toggleFacetValue:c}}]),angular.module("xom.shared").factory("geolocationSvc",["$q","$window",function(a,b){"use strict";function c(){var c=a.defer();return b.navigator.geolocation?b.navigator.geolocation.getCurrentPosition(c.resolve,c.reject):c.reject("Geolocation not supported."),c.promise}return{getCurrentPosition:c}}]),angular.module("xom.shared").service("serializationSvc",function(){"use strict";function a(a,b,c){var d=[];for(var e in a)a.hasOwnProperty(e)&&null!==a[e]&&""!==a[e]&&d.push(e+c+a[e]);return d.join(b)}function b(a,b,c){var d={},e=new RegExp("([^?"+c+b+"]+)("+c+"([^"+b+"]*))?","g");return a.replace(e,function(a,b,c,e){d[b]=e}),d}return{serialize:a,deserialize:b,toQueryString:function(b){return a(b,"&","=")},fromQueryString:function(a){return b(a,"&","=")}}});