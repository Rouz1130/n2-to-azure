/*! 2016-09-16 10:11:33 */
!function(a){"use strict";function b(a){return a.data(s)}function c(a){for(var b=a.entities.getLength(),c=[],d=0;d<b;d++){var e=a.entities.get(d);e.getLocation&&c.push(e.getLocation())}return c}function d(b,c,d){var e=20,f=a(".map-popup"),g=-d.height,h=f.outerWidth(),i=f.outerHeight(),j=b.getWidth(),k=b.tryLocationToPixel(c.getLocation(),Microsoft.Maps.PixelReference.control),l=k.y-i+g,m=k.x-h/2,n=m+h,o=Math.max(e-m,0),p=Math.min(j-n-e,0),q=o||p,r=Math.max(e-l,0);b.setView({centerOffset:new Microsoft.Maps.Point(q,r),center:b.getCenter()})}function e(a){return'<div class="map-popup map-popup-bing"><a type="button" class="close" aria-label="Close"><span aria-hidden="true">&times;</span></a><i class="icon-popup-arrow"></i>'+a+"</div>"}function f(a,b){var c,d={add:[],remove:[]},e=a.bingMap.entities.getLength();for(c=0;c<e;c++){var f=a.bingMap.entities.get(c);!f.pin||g(b,f)>=0||d.remove.push(f)}for(c=0;c<b.length;c++)h(a.bingMap.entities,e,b[c])>=0||d.add.push(b[c]);return d}function g(a,b){for(var c=0;c<a.length;c++)if(a[c].id==b.pin.id)return c;return-1}function h(a,b,c){for(var d=0;d<b;d++){var e=a.get(d);if(e.pin&&e.pin.id==c.id)return d}return-1}function i(a,b){var c=new Microsoft.Maps.Pushpin(b.position,{draggable:!1,htmlContent:'<img class="map-pin" src="'+(b.image||a.options.pin.image)+'" />'});if(c.pin=b,a.bingMap.entities.push(c),c.pin.popup){var f=function(c){var f=c.target,g=e(f.pin.popup),h=r(a,g),i={htmlContent:e(f.pin.popup),location:f.getLocation(),offset:new Microsoft.Maps.Point(h.width,h.height),pushpin:f,visible:!0};null!==a.infobox&&a.bingMap.entities.remove(a.infobox),a.infobox=new Microsoft.Maps.Infobox(i.location,i),a.bingMap.entities.push(a.infobox),d(a.bingMap,f,h),Microsoft.Maps.Events.addHandler(a.infobox,"click",k),"function"==typeof a.onPinOpenedInternal&&a.onPinOpenedInternal(b)};Microsoft.Maps.Events.addHandler(c,"click",f)}}function j(a,b){a.bingMap.entities.remove(b)}function k(b){var c=b.target,d=a(b.originalEvent.target);(d.is(".close")||d.closest(".close").length)&&c.setOptions({visible:!1})}function l(b,c){var d={data:{c:b.options.languageCode,jsonp:"GeocodeCallback",key:b.options.key,q:c},dataType:"jsonp",jsonpCallback:"GeocodeCallback",method:"GET",url:"https://dev.virtualearth.net/REST/v1/Locations"};a.ajax(d).done(function(a){if(0===a.resourceSets.length||0===a.resourceSets[0].resources.length){if("function"!=typeof b.onGeocodeInternal)return;return void b.onGeocodeInternal({provider:"Bing",count:0})}var c=a.resourceSets[0].resources[0],d=c.point.coordinates,e=c.bbox,f=Microsoft.Maps.LocationRect.fromLocations(new Microsoft.Maps.Location(e[0],e[1]),new Microsoft.Maps.Location(e[2],e[3]));b.bingMap.setView({bounds:f}),"function"==typeof b.onGeocodeInternal&&b.onGeocodeInternal({address:c.address,count:a.resourceSets[0].resources.length,countryRegion:c.address.countryRegion,latitude:d[0],longitude:d[1],name:c.name,provider:"Bing",type:c.entityType})})}function m(a,b,c){a.bingMap.setView({center:new Microsoft.Maps.Location(b,c),zoom:a.options.zoom}),"function"==typeof a.onCenterSetInternal&&a.onCenterSetInternal({latitude:b,longitude:c})}function n(a,b){b.mouseMoved&&b.isPrimary&&q(a,"Drag")}function o(a,b){var c=a.bingMap.getZoom();a.lastZoom!=c&&(a.lastZoom=c,q(a,"Zoom"))}function p(a,b){"mouseover"==b.eventName?(clearTimeout(a.hoverTimeout),a.hoverTimeout=setTimeout(function(){q(a,"Hover")},3e3)):"mouseout"==b.eventName&&clearTimeout(a.hoverTimeout)}function q(a,b){"function"==typeof a.onInteractionInternal&&a.onInteractionInternal(b)}function r(b,c){var d=a(c);d.css({position:"absolute",visibility:"hidden"}),d.appendTo("body");var e=a(".map-pin").outerHeight(!0),f=d.find(".icon-popup-arrow").outerHeight(!0),g=3,h={height:e+f-g,width:-(d.outerWidth(!0)/2)-g};return d.remove(),h}var s="em.map",t=function(b,c){a(b).addClass("map-bing"),this.options=a.extend({},c),this.infobox=null,this.bingMap=new Microsoft.Maps.Map(b,{center:"object"==typeof c.center?new Microsoft.Maps.Location(c.center.latitude,c.center.longitude):null,credentials:c.key,disableMouseInput:c.disableMouse,disablePanning:c.disablePan,disableZooming:c.disableZoom,mapTypeId:Microsoft.Maps.MapTypeId[c.mapType],showDashboard:!c.disableZoom,showScalebar:c.showScale,zoom:c.zoom})};t.TYPE="Bing",t.VERSION="1.0",t.prototype.setPins=function(a){var c,d=b(this),e=f(d,a),h=null!==d.infobox?d.infobox.getPushpin():null,k=null!==h&&g(a,h)===-1;for(c=0;c<e.add.length;c++)i(d,e.add[c]);for(c=0;c<e.remove.length;c++)j(d,e.remove[c]);k&&(d.bingMap.entities.remove(d.infobox),d.infobox=null)},t.prototype.setBoundaryToPins=function(){var a=b(this).bingMap,d=c(a),e=Microsoft.Maps.LocationRect.fromLocations(d);a.setView({bounds:e})},t.prototype.onBoundaryChanged=function(a){var c=b(this).bingMap;Microsoft.Maps.Events.addThrottledHandler(c,"viewchangeend",function(){var b=c.getBounds(),d={latitude1:b.center.latitude-b.height/2,latitude2:b.center.latitude+b.height/2,longitude1:b.center.longitude-b.width/2,longitude2:b.center.longitude+b.width/2};a(d)},300)},t.prototype.onCenterSet=function(a){b(this).onCenterSetInternal=a},t.prototype.onGeocode=function(a){b(this).onGeocodeInternal=a},t.prototype.onInteraction=function(a){b(this).onInteractionInternal=a},t.prototype.onPinOpened=function(a){b(this).onPinOpenedInternal=a},t.prototype.getBounds=function(){return b(this).bingMap.getBounds()},t.prototype.center=function(a){var c=b(this);"string"==typeof a?l(c,a):"object"==typeof a&&m(c,a.latitude,a.longitude)},t.prototype.zoom=function(a){return b(this).bingMap.setView({zoom:a})};var u=function(b){var c=arguments.length>1?arguments[1]:void 0;return this.each(function(){var d=a(this),e=d.data(s);e||d.data(s,e=new t(this,b)),"string"==typeof b&&"function"==typeof e[b]?e[b].call(d,c):(e.lastZoom=e.bingMap.getZoom(),Microsoft.Maps.Events.addHandler(e.bingMap,"click",function(a){n(e,a)}),Microsoft.Maps.Events.addThrottledHandler(e.bingMap,"viewchangeend",function(a){o(e,a)}),Microsoft.Maps.Events.addHandler(e.bingMap,"mouseover",function(a){p(e,a)}),Microsoft.Maps.Events.addHandler(e.bingMap,"mouseout",function(a){p(e,a)}))})};a.fn.mapify=u,a.fn.mapify.Constructor=t}(window.jQuery);